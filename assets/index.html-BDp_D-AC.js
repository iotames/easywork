import{_ as s,c as n,e,o as l}from"./app-D3rUnszu.js";const i={};function o(t,a){return l(),n("div",null,[...a[0]||(a[0]=[e(`<h2 id="grafana介绍" tabindex="-1"><a class="header-anchor" href="#grafana介绍"><span>Grafana介绍</span></a></h2><p>Grafana是一款用 <code>Go</code> 语言写的开源跨平台 <code>度量分析</code> 和可视化工具。是应用分析中最流行的 <code>时序数据</code> 展示工具，目前已支持大部分常用的 <code>时序数据库</code>。 可以与整个团队共享，有助于培养团队的数据驱动文化。</p><h2 id="主要用途" tabindex="-1"><a class="header-anchor" href="#主要用途"><span>主要用途</span></a></h2><ol><li><p>Grafana 能够查询、可视化、提醒和探索指标、<code>日志</code> 和跟踪，无论它们存储在何处。Grafana OSS 插件框架还使您能够连接其他数据源，例如 NoSQL/SQL 数据库。</p></li><li><p>通知提醒：以可视方式定义最重要指标的警报规则，Grafana将不断计算并发送通知，在数据达到阈值时（可置顶告警规则）通过 飞书、钉钉、企业微信 等获得通知</p></li></ol><h2 id="资源" tabindex="-1"><a class="header-anchor" href="#资源"><span>资源</span></a></h2><ul><li>项目主页：https://github.com/grafana/grafana</li></ul><h3 id="下载地址" tabindex="-1"><a class="header-anchor" href="#下载地址"><span>下载地址</span></a></h3><ul><li>Promtail日志采集器：https://github.com/grafana/loki/releases/download/v3.4.5/promtail-linux-amd64.zip</li><li>Loki日志存储：https://github.com/grafana/loki/releases/download/v3.4.5/loki-linux-amd64.zip</li><li>Grafana数据可视化：https://github.com/grafana/grafana/releases</li></ul><h2 id="下载和安装" tabindex="-1"><a class="header-anchor" href="#下载和安装"><span>下载和安装</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 下载指定版本的Grafana</span></span>
<span class="line"><span class="token comment"># 可以添加 -e 参数指定代理，以加速下载。</span></span>
<span class="line"><span class="token comment"># wget -e https_proxy=http://127.0.0.1:7890 -c https://dl.grafana.com/oss/release/grafana-12.0.2.linux-amd64.tar.gz</span></span>
<span class="line"><span class="token function">wget</span> <span class="token parameter variable">-c</span> https://dl.grafana.com/oss/release/grafana-12.0.2.linux-amd64.tar.gz</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 解压缩</span></span>
<span class="line"><span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> grafana-12.0.2.linux-amd64.tar.gz</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 进入目录</span></span>
<span class="line"><span class="token builtin class-name">cd</span> grafana-12.0.2</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 启动Grafana</span></span>
<span class="line">./bin/grafana-server web</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="日志监控方案" tabindex="-1"><a class="header-anchor" href="#日志监控方案"><span>日志监控方案</span></a></h2><p><code>Promtail</code> 日志采集器（Loki官方） + <code>Loki</code> 日志存储系统（日志聚合）+ <code>Grafana</code> 数据展示和告警</p><p>以监控 <code>Odoo</code> 应用的运行日志为例：</p><ol><li>首先配置Odoo日志确保正确输出</li><li>部署和配置Promtail来采集odoo.log文件</li><li>部署Loki作为日志存储</li><li>配置Grafana连接Loki数据源并进行日志查询</li></ol><h3 id="日志输出和权限配置" tabindex="-1"><a class="header-anchor" href="#日志输出和权限配置"><span>日志输出和权限配置</span></a></h3><p>Odoo配置文件 <code>odoo.conf</code></p><div class="language-conf line-numbers-mode" data-highlighter="prismjs" data-ext="conf"><pre><code class="language-conf"><span class="line">logfile = /var/log/odoo/odoo-server.log  # 日志文件路径</span>
<span class="line">log_level = info  # 日志级别（debug/info/warning/error）</span>
<span class="line">log_handler = :DEBUG  # 模块级日志调试</span>
<span class="line"></span>
<span class="line"># 此格式与Promtail的regex表达式完全匹配，避免解析失败</span>
<span class="line">log_format = %(asctime)s %(process)d %(levelname)s %(name)s: %(message)s</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>权限设置</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">sudo</span> <span class="token function">mkdir</span> /var/log/odoo</span>
<span class="line"><span class="token function">sudo</span> <span class="token function">chown</span> odoo:odoo /var/log/odoo  <span class="token comment"># odoo为运行用户</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="​部署promtail-日志采集" tabindex="-1"><a class="header-anchor" href="#​部署promtail-日志采集"><span>​部署Promtail（日志采集）</span></a></h3><p>配置文件：promtail-config.yaml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">http_listen_port</span><span class="token punctuation">:</span> <span class="token number">9080</span></span>
<span class="line"><span class="token key atrule">clients</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//loki<span class="token punctuation">:</span>3100/loki/api/v1/push  <span class="token comment"># Loki服务地址</span></span>
<span class="line"><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> odoo</span>
<span class="line">    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>localhost<span class="token punctuation">]</span></span>
<span class="line">        <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">job</span><span class="token punctuation">:</span> odoo  <span class="token comment"># 标签用于Grafana筛选</span></span>
<span class="line">          <span class="token key atrule">__path__</span><span class="token punctuation">:</span> /var/log/odoo/<span class="token important">*.log</span>  <span class="token comment"># Odoo日志路径</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Docker启动：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> promtail <span class="token parameter variable">-v</span> ./promtail-config.yaml:/etc/promtail/config.yaml <span class="token parameter variable">-v</span> /var/log/odoo:/var/log/odoo grafana/promtail</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="部署loki-日志存储" tabindex="-1"><a class="header-anchor" href="#部署loki-日志存储"><span>部署Loki（日志存储）</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">docker</span> pull grafana/loki:3.5.1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>配置文件：loki-config.yaml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">auth_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">http_listen_port</span><span class="token punctuation">:</span> <span class="token number">3100</span></span>
<span class="line"><span class="token key atrule">storage_config</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">filesystem</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">directory</span><span class="token punctuation">:</span> /tmp/loki/chunks  <span class="token comment"># 存储路径（生产环境建议用S3）</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Docker启动：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> loki <span class="token parameter variable">-p</span> <span class="token number">3100</span>:3100 <span class="token parameter variable">-v</span> ./loki-config.yaml:/etc/loki/config.yaml grafana/loki:3.5.1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="配置grafana连接loki" tabindex="-1"><a class="header-anchor" href="#配置grafana连接loki"><span>配置Grafana连接Loki</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">docker</span> pull grafana/grafana:12.0.2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol><li><p>登录Grafana → ​​Configuration​​ → ​​Data Sources​​ → ​​Add data source​： 选择Loki作为数据源类型，配置Loki的URL（容器内通信地址示例：http://loki:3100）</p></li><li><p>查询与可视化日志​​：进入 Explore 页面，选择 Loki 数据源，输入查询语句。</p></li></ol><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">{job=&quot;odoo&quot;} |= &quot;error&quot;  # 筛选包含&quot;error&quot;的日志</span>
<span class="line">{job=&quot;odoo&quot;} | logfmt     # 解析结构化日志（如JSON格式）</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>​​创建监控仪表盘</li></ol><ul><li>将常用查询保存为Dashboard面板（如错误日志统计、登录频率）</li></ul><p>​- ​日志表格​​：展示原始日志细节 ​- ​柱状图​​：按时间统计错误次数（如count_over_time({job=&quot;odoo&quot;} |~ &quot;error&quot; [5m])）</p><hr><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料"><span>参考资料</span></a></h2><blockquote><p>Grafana官方文档：https://grafana.com/docs/grafana/latest/getting-started</p></blockquote><blockquote><p>Loki官方文档 https://grafana.com/docs/loki/latest</p></blockquote><blockquote><p>Grafana 应用总结 https://blog.csdn.net/m0_62066780/article/details/131580224</p></blockquote><blockquote><p>Grafana+Loki使用文档 https://blog.csdn.net/weixin_73610377/article/details/147264197</p></blockquote><blockquote><p>Grafana快速入门指南下篇 https://www.cnblogs.com/yinzhengjie/p/18538430</p></blockquote><blockquote><p>Grafana安装与使用指南：从基础到进阶 https://edu.51cto.com/article/note/25701.html</p></blockquote>`,45)])])}const c=s(i,[["render",o]]),r=JSON.parse('{"path":"/devops/grafana/","title":"","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1752422697000,"contributors":[{"name":"Hankin","username":"Hankin","email":"hankin@catmes.com","commits":4,"url":"https://github.com/Hankin"}],"changelog":[{"hash":"dc1ff8ad7a266889c76b9ccb98473be4ad49392b","time":1752422697000,"email":"hankin@catmes.com","author":"Hankin","message":"ADD loki_nginx.md"},{"hash":"2532d20cad7caa42d194628f1d1086e92212170a","time":1752227037000,"email":"whq78164@gmail.com","author":"Hankin","message":"UPDATE promtail, loki"},{"hash":"39d821a62f30206a59f608169caef96118afa4c4","time":1752206694000,"email":"whq78164@gmail.com","author":"Hankin","message":"ADD logrotate. ADD grafana, promtail, loki"},{"hash":"a2857f58ffbc071bd10dd5a89c06145a4f4dfbca","time":1751472567000,"email":"hankin@catmes.com","author":"Hankin","message":"ADD grafana for devops"}]},"filePathRelative":"devops/grafana/README.md"}');export{c as comp,r as data};
