import{_ as l,c as o,e as n,a as s,d as i,w as t,r as c,o as p,b as d}from"./app-B0UrfQJy.js";const r={};function u(m,a){const e=c("RouteLink");return p(),o("div",null,[a[1]||(a[1]=n(`<h2 id="日志看板" tabindex="-1"><a class="header-anchor" href="#日志看板"><span>日志看板</span></a></h2><h3 id="日志准备" tabindex="-1"><a class="header-anchor" href="#日志准备"><span>日志准备</span></a></h3><p>Odoo配置文件 <code>odoo.conf</code></p><div class="language-conf line-numbers-mode" data-highlighter="prismjs" data-ext="conf"><pre><code class="language-conf"><span class="line">logfile = /var/log/odoo/odoo-server.log  # 日志文件路径</span>
<span class="line">log_level = info  # 日志级别（debug/info/warning/error）</span>
<span class="line">log_handler = :DEBUG  # 模块级日志调试</span>
<span class="line"></span>
<span class="line"># 此格式与Promtail的regex表达式完全匹配，避免解析失败</span>
<span class="line">log_format = %(asctime)s %(process)d %(levelname)s %(name)s: %(message)s</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>权限设置</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">sudo</span> <span class="token function">mkdir</span> /var/log/odoo</span>
<span class="line"><span class="token function">sudo</span> <span class="token function">chown</span> odoo:odoo /var/log/odoo  <span class="token comment"># odoo为运行用户</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="日志采集" tabindex="-1"><a class="header-anchor" href="#日志采集"><span>日志采集</span></a></h3>`,7)),s("ul",null,[s("li",null,[i(e,{to:"/devops/grafana/promtail/"},{default:t(()=>[...a[0]||(a[0]=[d("promtail日志采集器",-1)])]),_:1})])]),a[2]||(a[2]=n(`<p>配置文件：promtail-config.yaml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">http_listen_port</span><span class="token punctuation">:</span> <span class="token number">9080</span></span>
<span class="line"><span class="token key atrule">clients</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//loki<span class="token punctuation">:</span>3100/loki/api/v1/push  <span class="token comment"># Loki服务地址</span></span>
<span class="line"><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> odoo</span>
<span class="line">    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>localhost<span class="token punctuation">]</span></span>
<span class="line">        <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">job</span><span class="token punctuation">:</span> odoo  <span class="token comment"># 标签用于Grafana筛选</span></span>
<span class="line">          <span class="token key atrule">__path__</span><span class="token punctuation">:</span> /var/log/odoo/<span class="token important">*.log</span>  <span class="token comment"># Odoo日志路径</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="变量设置" tabindex="-1"><a class="header-anchor" href="#变量设置"><span>变量设置</span></a></h3><ol><li>进入仪表板，点击 <code>Edit</code> 按钮， 然后点击左边的 <code>Settings</code>，进入仪表板设置。</li><li>点击 <code>变量</code> 选项卡，添加 <code>env</code> 和 <code>log_level</code> 两个变量。</li></ol><ul><li>env</li></ul><ol><li>Variable type: Query</li><li>Name: env</li><li>Data source: Loki</li><li>Query type: Label values</li><li>Label: env</li></ol><ul><li>log_level</li></ul><ol><li>Variable type: Custom</li><li>Name: log_level</li><li>Label: 日志级别</li><li>Values separated by comma: error,warn,info,unknown</li><li>Selection options: <code>Multi-value</code>, Include All option -&gt; Custom all value: <code>.*</code></li></ol><ul><li>query</li></ul><ol><li>Variable type: TextBox</li><li>Name: query</li><li>Label: 模糊搜索</li></ol><h2 id="编辑仪表板" tabindex="-1"><a class="header-anchor" href="#编辑仪表板"><span>编辑仪表板</span></a></h2><ol><li>点击仪表板右上角的 <code>竖排的三个点</code>，弹出菜单，点击 <code>编辑</code>。</li><li>在面板编辑界面，选择 <code>查询</code>（<code>Queries</code>）选项卡，点击 <code>添加查询</code>（<code>Add query</code>）。</li><li>以下面两种看板为例，编辑模式都切换为 <code>Code</code></li><li><code>Time series</code>看板: Code语句：<code>sum(count_over_time({job=&quot;odoo17&quot;, env=&quot;$env&quot;} |= </code>$query<code>| json | detected_level =~</code>$log_level<code> [$__interval]))</code></li><li><code>Logs</code>看板: Code语句：<code>{job=&quot;odoo17&quot;, env=&quot;$env&quot;} |= &quot;$query&quot; | json | detected_level =~ &quot;$log_level&quot;</code></li><li>在右上角保存结果。</li></ol>`,12))])}const k=l(r,[["render",u]]),h=JSON.parse('{"path":"/devops/grafana/dashboards.html","title":"","lang":"zh-CN","frontmatter":{},"git":{"updatedTime":1758536120000,"contributors":[{"name":"Hankin","username":"Hankin","email":"hankin@catmes.com","commits":3,"url":"https://github.com/Hankin"}],"changelog":[{"hash":"5bc1d1333a538fa8ed86a6a77e7f915fba47ea7e","time":1758536120000,"email":"554553400@qq.com","author":"Hankin","message":"UPDATE promtail grafana log kanban"},{"hash":"0318e015ea3a176b7a7f0277d7e49144d415f64e","time":1752560749000,"email":"whq78164@gmail.com","author":"Hankin","message":"UPDATE dashboards"},{"hash":"2c8089149db43f85a0b9075a659c9f9c95248ac7","time":1752511185000,"email":"hankin@catmes.com","author":"Hankin","message":"ADD dashboards.md for grafana"}]},"filePathRelative":"devops/grafana/dashboards.md"}');export{k as comp,h as data};
